<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>微服务框架(二)——Spring Cloud | Hurley</title><meta name="description" content="介绍 Spring Cloud provides tools for developers to quickly build some of the common patterns in distributed systems (e.g. configuration management, service discovery, circuit breakers, intelligent routi"><meta name="keywords" content="Spring Cloud"><meta name="author" content="Hurley"><meta name="copyright" content="Hurley"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://raw.githubusercontent.com/HurleyJames/ImageHosting/master/icon.png"><link rel="canonical" href="https://hurleyjames.github.io/2021/01/02/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6(%E4%BA%8C)%E2%80%94%E2%80%94Spring%20Cloud/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="微服务框架(二)——Spring Cloud"><meta property="og:url" content="https://hurleyjames.github.io/2021/01/02/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6(%E4%BA%8C)%E2%80%94%E2%80%94Spring%20Cloud/"><meta property="og:site_name" content="Hurley"><meta property="og:description" content="介绍 Spring Cloud provides tools for developers to quickly build some of the common patterns in distributed systems (e.g. configuration management, service discovery, circuit breakers, intelligent routi"><meta property="og:image" content="https://hurleyjames.github.io/../image/spring-cloud.png"><meta property="article:published_time" content="2021-01-01T16:00:00.000Z"><meta property="article:modified_time" content="2021-01-08T12:53:31.558Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="next" title="微服务框架(一)——Dubbo" href="https://hurleyjames.github.io/2021/01/01/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6(%E4%B8%80)--Dubbo/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: false,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: true,
  fancybox: false,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: true,
  islazyload: true,
  isanchor: false    
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true
  }</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://avatars1.githubusercontent.com/u/26319720?s=460&amp;v=4" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">72</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">31</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">15</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><i class="fas fa-arrow-right" id="toggle-sidebar"></i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#介绍"><span class="toc-number">1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#核心成员"><span class="toc-number">2.</span> <span class="toc-text">核心成员</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-Cloud-Eureka"><span class="toc-number">2.1.</span> <span class="toc-text">Spring Cloud Eureka</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-Cloud-Hystrix"><span class="toc-number">2.2.</span> <span class="toc-text">Spring Cloud Hystrix</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-Cloud-Zuul"><span class="toc-number">2.3.</span> <span class="toc-text">Spring Cloud Zuul</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-Cloud-Config"><span class="toc-number">2.4.</span> <span class="toc-text">Spring Cloud Config</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-Cloud-Sleuth"><span class="toc-number">2.5.</span> <span class="toc-text">Spring Cloud Sleuth</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-Cloud-Bus"><span class="toc-number">2.6.</span> <span class="toc-text">Spring Cloud Bus</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-Cloud-Stream"><span class="toc-number">2.7.</span> <span class="toc-text">Spring Cloud Stream</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-Cloud-Task"><span class="toc-number">2.8.</span> <span class="toc-text">Spring Cloud Task</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/../image/spring-cloud.png)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">Hurley</a></span><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">微服务框架(二)——Spring Cloud</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2021-01-02 00:00:00"><i class="far fa-calendar-alt fa-fw"></i> 发表于 2021-01-02</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2021-01-08 20:53:31"><i class="fas fa-history fa-fw"></i> 更新于 2021-01-08</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fas fa-inbox fa-fw post-meta__icon"></i><a class="post-meta__categories" href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta__icon"></i><span>字数总计:</span><span class="word-count">3.3k</span><span class="post-meta__separator">|</span><i class="far fa-clock fa-fw post-meta__icon"></i><span>阅读时长: 11 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="far fa-eye fa-fw post-meta__icon"></i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><blockquote>
<p>Spring Cloud provides tools for developers to quickly build some of the common patterns in distributed systems (e.g. configuration management, service discovery, circuit breakers, intelligent routing, micro-proxy, control bus, one-time tokens, global locks, leadership election, distributed sessions, cluster state). Coordination of distributed systems leads to boiler plate patterns, and using Spring Cloud developers can quickly stand up services and applications that implement those patterns. They will work well in any distributed environment, including the developer’s own laptop, bare metal data centres, and managed platforms such as Cloud Foundry.</p>
</blockquote>
<p>Spring Cloud是一系列框架的有序集合，它利用SpringBoot的开发便利性，巧妙地简化了分布式系统的基础设施的开发，如服务发现注册、配置中心、消息总线、负载均衡、断路器、数据监控等，都可以做到一键启动和部署。</p>
<p><strong>选用Spring Cloud的好处包括</strong>：</p>
<ul>
<li>基于HTTP协议，使用RESTFUL风格，接口简单方便，高效透明（Dubbo是使用RPC协议，性能稍优于HTTP协议，但是耦合度更高）</li>
</ul>
<h2 id="核心成员"><a href="#核心成员" class="headerlink" title="核心成员"></a>核心成员</h2><ul>
<li>服务注册中心：Spring Cloud Netflix Eureka</li>
<li>服务调用方式：RESTFUL API</li>
<li>服务监控：SpringBoot Admin</li>
<li>断路器：Spring Cloud Netflix Hystrix</li>
<li>服务网关：Spring Cloud Netflix Zuul</li>
<li>分布式配置：Spring Cloud Config</li>
<li>服务跟踪：Spring Cloud Sleuth</li>
<li>消息总线：Spring Cloud Bus</li>
<li>数据流：Spring Cloud Stream</li>
<li>批量任务：Spring Cloud Task</li>
</ul>
<h3 id="Spring-Cloud-Eureka"><a href="#Spring-Cloud-Eureka" class="headerlink" title="Spring Cloud Eureka"></a>Spring Cloud Eureka</h3><p>Eureka是Netflix开发的服务发现组件，本身是一个基于REST的服务，主要用于定位运行在AWS域中的中间层服务，以达到负载均衡和中间层服务故障转移的目的。Spring Cloud将其集成在其子项目spring-cloud-netflix上，以实现Spring Cloud的服务发现功能。</p>
<p>我们可以将自定义的API接口注册到Spring Cloud Eureka上，Eureka负责服务的注册与发现，它的角色与ZooKeeper差不多，都是服务的注册与发现。所以，构成Eureka体系的包括：服务注册中心、服务提供者、服务消费者，主要包含两个组件：Eureka Server和Eureka Client。</p>
<p><img src= "/img/loading.gif" data-src="https://s3.ax1x.com/2021/01/07/seo74I.png" alt="High Level Architecture"></p>
<blockquote>
<p>The architecture above depicts how Eureka is deployed at Netflix and this is how you would typically run it. There is <strong>one</strong> eureka cluster per <strong>region</strong> which knows only about instances in its region. There is at the least <strong>one</strong> eureka server per zone to handle <strong>zone</strong> failures.</p>
<p>Services <strong>register</strong> with Eureka and then send <strong>heartbeats</strong> to renew their leases every 30 seconds. If the client cannot renew the lease for a few times, it is taken out of the server registry in about 90 seconds. The registration information and the renewals are replicated to all the eureka nodes in the cluster. The clients from any zone can look up the <strong>registry</strong> information (happens every 30 seconds) to locate their services (which could be in any zone) and make remote calls.</p>
</blockquote>
<p>Eureka Server提供服务注册功能，提供者节点启动后，会在Eureka Server中进行注册，所以Eureka Server的服务注册表中将会存储所有可用服务节点的信息。各个提供者会向Euraka Server发送心跳，以告知Eureka Server自己的健康状况，默认周期为30秒。如果在多个心跳周期内都没有接收到某个提供者节点的心跳，那么Eureka Server就会认为其已经无法提供服务，就会将该节点从服务注册表中移除。Eureka Server之间是通过复制的方式完成数据的同步。</p>
<p>Eureka Client是一个Java客户端，是用于简化消费者与Eureka Server的交互。同时，Eureka Client内置有负载均衡器，为消费者从Eureka Server的服务注册表中选择合适的提供者。</p>
<p>Eureka提供了客户端缓存机制，即使所有的Eureka Server都宕机，客户端仍然能够利用缓存的信息为消费者提供服务发现功能。但此时就不再接受服务注册。</p>
<p>综上，Eureka通过心跳检查、客户端缓存等机制，确保了系统的高可用性、灵活性和可伸缩性。</p>
<h3 id="Spring-Cloud-Hystrix"><a href="#Spring-Cloud-Hystrix" class="headerlink" title="Spring Cloud Hystrix"></a>Spring Cloud Hystrix</h3><p>Hystrix的意思是豪猪，所以，它表明了框架的主要功能：<strong>自我保护功能</strong>。Hystrix是一个用于处理分布式系统的延迟和容错的开源库。Hystrix具有服务降级，熔断，线程池隔离，信号量隔离，缓存等功能。它能够保证在一个依赖出现问题的情况下，不会倒置整体服务失败，避免级联故障，提高分布式系统的弹性。</p>
<p>「断路器」本身是一种开关装置，当某个服务单元发生故障之后，通过断路器的故障监控（类似保险熔断），向调用方法返回一个符合预期的，可处理的被选相应（FallBack降级操作），而不是长时间的等待或者抛出无法处理的异常。这样保证了服务调用方法的线程不会长时间，不必要地占用，从而避免了故障在分布式系统中的蔓延，从而导致雪崩效应。</p>
<p>如下图所示，断路器有对应的三个阶段：</p>
<ul>
<li>第一阶段：正常</li>
<li>第二阶段：发现超时或者失败后，标识失败</li>
<li>第三阶段：达到阈值之后，触发了熔断器策略，标识服务不可用，熔断器就自动断开。如果此时B对C有访问，熔断器会给B立刻返回失败，不再调用C。同时进行间断性尝试，判断服务是否恢复</li>
</ul>
<p><img src= "/img/loading.gif" data-src="https://s3.ax1x.com/2021/01/07/seooEd.png" alt="Hystrix的三种情况"></p>
<p>Hystrix存在三种模式：</p>
<ul>
<li><strong>断路器模式</strong>：设置超时或者失败等熔断策略</li>
<li><strong>后备策略模式</strong>：在第二阶段或者第三阶段失败时，如果存在后备策略，都会去执行后备策略</li>
<li><strong>舱壁模式</strong>：保证一个服务独享一个线程池</li>
</ul>
<p>所以，Hystrix的功能执行如下：</p>
<ul>
<li>熔断触发前，超时或者失败发生时：<ul>
<li>如果存在后备策略，执行后备策略</li>
<li>如果不存在后备策略，抛出异常处理</li>
</ul>
</li>
<li>在熔断触发之前后，立即返回失败，保护下游失败<ul>
<li>存在后备策略，则执行</li>
<li>不存在，则抛出异常</li>
</ul>
</li>
<li>在熔断器触发了之后，还可以定期检查服务是否正常，将服务恢复正常</li>
</ul>
<h3 id="Spring-Cloud-Zuul"><a href="#Spring-Cloud-Zuul" class="headerlink" title="Spring Cloud Zuul"></a>Spring Cloud Zuul</h3><p>Spring Cloud Zuul是Spring Cloud Netflix子项目的核心组件之一，可以作为微服务架构中的API网关使用，支持动态请求路由、负载均衡、效验过滤、服务容错、服务聚合等功能。API网关为微服务架构中的服务提供了统一的访问入口，客户端通过API网关访问相关服务。</p>
<p>Zuul的核心是一系列的Filters，其作用类比于Servlet框架的Filter，或者AOP。其大部分功能都是通过过滤器来实现的，它们能够执行非常大范围的操作，并且可以在请求-响应生命周期的不同阶段运行，如下图所示：</p>
<p><img src= "/img/loading.gif" data-src="https://s3.ax1x.com/2021/01/07/seoTUA.png" alt="Zuul"></p>
<p>其定义了四种标准过滤器类型：</p>
<ul>
<li>PRE：这种过滤器在请求被路由之前调用。可以用这种过滤器实现身份验证、在集群中选择请求的微服务、记录调试信息等</li>
<li>ROUTING：这种过滤器是用于构建发送给微服务的请求，并使用Apache HttpClient或者Netflix Ribbon请求微服务</li>
<li>POST：这种过滤器在路由到微服务以后执行，可用来为响应添加标准的HTTP Header、收集统计信息和指标、将相应从微服务发回给客户端等</li>
<li>ERROR：在其它阶段发生错误时执行该过滤器</li>
</ul>
<p><img src= "/img/loading.gif" data-src="https://s3.ax1x.com/2021/01/07/seo5HH.png" alt="Zuul四种标准过滤器模型"></p>
<h3 id="Spring-Cloud-Config"><a href="#Spring-Cloud-Config" class="headerlink" title="Spring Cloud Config"></a>Spring Cloud Config</h3><p>在分布式系统中，因为服务数量很多，为了方便服务配置文件统一管理，实时更新，所以需要分布式配置中心组件。在Spring Cloud中，有分布式配置中心组件Spring Cloud Config，它支持配置服务放在配置服务的内存中（本地），也支持放在远程Git中。</p>
<p>在Spring Cloud Config组件中，分两个角色：</p>
<ul>
<li>Config Server：一个可横向扩展、集中式的配置服务器，它用于集中管理应用程序各个环境下的配置，为客户端提供获取配置信息、加密、解密信息等访问接口</li>
<li>Config Client：是Config Server的客户端，是微服务架构中的各个微服务应用或基础设施，通过指定的配置中心来管理应用资源与业务相关的配置内容，并在启动的时候从配置中心获取和加载配置信息。</li>
</ul>
<p>基于消息总线的配置中心架构需要依赖外部的MQ组件，例如RabbitMQ或者Kafka等实现远程环境变更通知，客户端实时配置变更可以基于Git Hook功能实现。</p>
<h3 id="Spring-Cloud-Sleuth"><a href="#Spring-Cloud-Sleuth" class="headerlink" title="Spring Cloud Sleuth"></a>Spring Cloud Sleuth</h3><p>随着微服务部署的节点增多，以及对各个微服务的拆分后，对服务本身的日志和调用链路的监控变得更加困难。Spring Cloud Sleuth就是为了解决分布式链路追踪这个问题而生的。</p>
<p>Spring Cloud Sleuth的实体概念主要来源于谷歌在2010年发表的一篇论文：《Dapper, a Large-Scale Distributed Systems Tracing Infrastructure》：</p>
<ul>
<li>Span：基本工作单元。发送RPC就是一个新的span，就像RPC发送响应那样。Span携带了span的唯一64位标识、另外一个Trace的64位的标识。Span还有其余的数据，例如描述、带时间戳的事件、键值annotations（标签）等。</li>
<li>Trace：一组span造成的树状结构；</li>
<li>Annotation：用于及时记录事件的存在</li>
</ul>
<p>微服务日志追踪主要包括：</p>
<ul>
<li>日志输出</li>
<li>日志收集</li>
<li>分布式链路追踪：以集成Zipkin服务为基础，准备4个微服务工程：<ul>
<li>eureka server：复杂服务注册</li>
<li>zipkin server：负责链路数据收集以及查询</li>
<li>zuul-gateway：服务网关，负责调用</li>
<li>personal-service：作为后台server，负责调用</li>
</ul>
</li>
</ul>
<h3 id="Spring-Cloud-Bus"><a href="#Spring-Cloud-Bus" class="headerlink" title="Spring Cloud Bus"></a>Spring Cloud Bus</h3><p>Spring Cloud Config的作用的帮助更新配置文件，即配置文件可以通过Config Server存储到Git地方，通过Config Client进行读取。但是配置发生变化时，又是如何进行更新的呢？</p>
<p>一种简单的方式是关闭服务，重新让Config Client进行获取。但是这样需要关闭服务，Spring Cloud肯定不允许这样做。那么，它需要通过「消息总线」的方式来进行通知。</p>
<p>这套机制是：我们使用消息代理来构建一个Topic，然后把微服务架构中的所有服务都连接到这个主题上，当我们向该主题发送消息时，所有订阅了该主题的服务都会收到消息并进行消费。目前Spring Cloud Bus支持两种主流的消息代理：RabbitMQ和Kafka。</p>
<p><img src= "/img/loading.gif" data-src="https://i.loli.net/2021/01/08/cnVklGj5eQwHoih.jpg" alt="Spring Cloud Bus的执行步骤"></p>
<p>从上图可以看出Spring Cloud Bus的执行步骤：</p>
<ul>
<li>提交代码给客户端A</li>
<li>客户端A收到了请求，从Server端更新配置，发送给Spring Cloud Bus</li>
<li>Spring Cloud Bus接收到消息，<strong>通知</strong>其它的客户端</li>
<li>其它客户端接收到通知，请求Server端，获取最新的配置</li>
<li>这样，全部的客户端都能获取到更新的配置</li>
</ul>
<h3 id="Spring-Cloud-Stream"><a href="#Spring-Cloud-Stream" class="headerlink" title="Spring Cloud Stream"></a>Spring Cloud Stream</h3><p>Spring Cloud Stream在Spring Cloud体系内用于构建高度可扩展的基于事件驱动的微服务。而SCS(Spring Cloud Stream)是在Spring Message和Spring Integration两个项目的基础上完成构建的。</p>
<p>Spring Message模块是Spring Framework的一个模块，其作用就是统一消息的编程模型。</p>
<p>生产者Producer发送消息到消息通道Message Channel中，消费者Consumer调用<code>receive()</code>方法从消息通道中获取到消息。</p>
<p>Spring Integration提供了Spring编程模型的扩展，用来支持企业集成模式（Enterprise Integration Patterns）。</p>
<p>Spring Integration是对Spring Messaging的扩展。它提出了不少新的概念，包括消息的路由MessageRoute、消息的分发MessageDispatcher、消息过滤Filter、消息转换Transfoer、消息聚合Aggregator、消息分隔Splitter等等。</p>
<hr>
<p>SCS则是Spring Integration的加强，同时与SpringBoot体系融合，也是Spring Cloud Bus的基础。<strong>它屏蔽了底层消息中间件的实现细节，希望以统一的一套API来进行消息的发送/消费，底层消息中间件的实现细节由各消息中间件的Binder来完成</strong>。</p>
<p><img src= "/img/loading.gif" data-src="https://i.loli.net/2021/01/08/gFcrRKha52Vzibl.png" alt="Binder细节"></p>
<p>Binder是提供与外部消息中间件集成的组件，会构造Binding，内部构造实现生产者和消费者。<strong>它是连接应用程序跟消息中间件的桥梁，用于消息的消费和生产</strong>。</p>
<p>SCS解决了开发人员无感知的使用消息中间件的问题，因为SCS对消息中间件的进一步封装，可以做到代码层面对中间件的无感知，甚至还可以动态切换中间件。这使得微服务开发的高度解耦，服务可以主要关注自己的流程。</p>
<h3 id="Spring-Cloud-Task"><a href="#Spring-Cloud-Task" class="headerlink" title="Spring Cloud Task"></a>Spring Cloud Task</h3><p>Spring Cloud Task允许用户使用Spring Cloud开发和运行短期微服务，并在云和本地运行，甚至还可以在Spring Cloud Data Flow上运行。</p>
<p>Spring Cloud Task主要是来解决<code>short lived microservices</code>的问题的。因为一般的应用服务都是长时间运转的不停止的，但是有些服务却具有以下特点：</p>
<ul>
<li>定时的服务</li>
<li>临时的服务</li>
<li>占用资源过多的服务</li>
</ul>
<p>这些服务因为重要性偏低，所以可以交个Spring Cloud Task来执行。除此之外，有些任务是串联的。一个业务会牵扯到多个业务，任务之间是通过事件触发的，这就是Spring Cloud Stream来解决的。</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">Hurley</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://hurleyjames.github.io/2021/01/02/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6(%E4%BA%8C)%E2%80%94%E2%80%94Spring%20Cloud/">https://hurleyjames.github.io/2021/01/02/微服务框架(二)——Spring Cloud/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://hurleyjames.github.io" target="_blank">Hurley</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Spring-Cloud/">Spring Cloud</a></div><div class="post_share"><div class="social-share" data-image="/../image/spring-cloud.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><button class="reward-button"><i class="fas fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/images/wechat.JPG" alt="wechat" onclick="window.open('/images/wechat.JPG')"/><div class="post-qr-code__desc">wechat</div></li><li class="reward-item"><img class="post-qr-code__img" src="/images/alipay.JPG" alt="alipay" onclick="window.open('/images/alipay.JPG')"/><div class="post-qr-code__desc">alipay</div></li></ul></div></button></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2021/01/01/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6(%E4%B8%80)--Dubbo/"><img class="next-cover" data-src="/../image/dubbo.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">微服务框架(一)——Dubbo</div></div></a></div></nav></article></main><footer id="footer" style="background-image: url(/../image/spring-cloud.png)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2017 - 2021 By Hurley</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="footer_custom_text">随时意气风发，独自声势浩大</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><button id="readmode" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script id="ribbon_piao" mobile="false" src="/js/third-party/piao.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script><script>var endLoading = function () {
  document.body.style.overflow = 'auto';
  document.getElementById('loading-box').classList.add("loaded")
}
window.addEventListener('load',endLoading)</script></body></html>